#!/usr/bin/python

import os
import sys
import argparse
import urlparse

import baip_loader

CONF = os.path.join(os.sep, 'etc', 'baip', 'conf', 'loader.conf')
DESCRIPTION = """BAIP CSIRO Translation Tool"""


def main():
    """Script entry point.

    """
    parser = argparse.ArgumentParser(description=DESCRIPTION)
    parser.add_argument('-c',
                        '--config-file',
                        action='store',
                        dest='config_file')

    # Add sub-command support.
    subparsers = parser.add_subparsers(help='commands')

    # 'scrape' subcommand.
    scrape_help = 'Pull data from CSIRO endpoint'
    scrape_parser = subparsers.add_parser('scrape', help=scrape_help)
    scrape_parser.set_defaults(func=scrape)

    outfile_help = 'Override output filename'
    scrape_parser.add_argument('-o',
                               '--outfile',
                               action='store',
                               help=outfile_help,
                               dest='outfile')

    args = parser.parse_args()

    config_file = args.config_file
    if args.config_file is None:
        if os.path.exists(CONF):
            config_file = CONF

    if config_file is None:
        sys.exit('Unable to source the BAIP loader.conf')
    else:
        conf = baip_loader.LoaderConfig(config_file)
        conf.parse_config()

    args.func(args, conf)


def scrape(args, conf):
    scraper = baip_loader.Loader()

    schema = conf.csiro_url_scheme
    netloc = conf.csiro_netloc
    path = conf.csiro_path
    uri = urlparse.urlunsplit((schema, netloc, path, None, None))
    scraper.csiro_source_uri = uri

    scraper.source()
    if args.outfile is not None:
        scraper.dump_source(args.outfile)


if __name__ == '__main__':
    main()
